# https://cloud.google.com/config-connector/docs/reference/resource-docs/container/containercluster#spec
# gcloud alpha blueprints apply --source=https://source.developers.google.com/p/$PROJECT_ID/r/blueprints-repo@master --source-git-subdir=subdirectory $DEPLOYMENT_NAME

apiVersion: container.cnrm.cloud.google.com/v1beta1
kind: ContainerCluster
metadata:
  namespace: config-controller-system # {"$kpt-set":"namespace"}
  labels:
    availability: dev
    target-audience: development
  name: blueprints-project-gke # {"$ref":"#/definitions/io.k8s.cli.substitutions.gke-name"}
  annotations:
    cnrm.cloud.google.com/project-id: blueprints-project # {"$kpt-set":"project-id"}
spec:
  description: A GKE cluster confined to one zone configured for development.
  location: $GKE_REGION # us-central1-f (region or zone)
  networkRef:
    external: https://compute.googleapis.com/compute/v1/projects/some-project-id/global/networks/default # {"$ref":"#/definitions/io.k8s.cli.substitutions.network"}
  subnetworkRef:
    external: https://www.googleapis.com/compute/v1/projects/some-project-id/regions/us-west1/subnetworks/default # {"$ref":"#/definitions/io.k8s.cli.substitutions.subnetwork"}
  ipAllocationPolicy:
#    clusterIpv4CidrBlock: string
    clusterSecondaryRangeName: $POD_IP_RANGE_NAME # string
#    servicesIpv4CidrBlock: string
    servicesSecondaryRangeName: $SVC_IP_RANGE_NAME # string
  initialNodeCount: 1
  defaultMaxPodsPerNode: 16
  privateClusterConfig:
    enablePrivateEndpoint: false
    enablePrivateNodes: true
    masterGlobalAccessConfig:
      enabled: true
    masterIpv4CidrBlock: $MASTER_IP_RANGE
  nodeConfig:
    machineType: $MACHINE_TYPE # "e2-medium"
    preemptible: $IF_PREEMPTIBLE # true
    diskSizeGb: $DISK_GB # 32 (in GB)
    oauthScopes:
    - "https://www.googleapis.com/auth/cloud-platform"
  workloadIdentityConfig:
    identityNamespace: "$PROJECT_ID.svc.id.goog" # {"$ref":"#/definitions/io.k8s.cli.substitutions.workloadidentity"}
  datapathProvider: "ADVANCED_DATAPATH"
  addonsConfig:
    gcePersistentDiskCsiDriverConfig:
      enabled: false
    horizontalPodAutoscaling:
      disabled: false
    httpLoadBalancing:
      disabled: false